---
lang: zh-CN
title: ● HTTPS 协议
description: 网络协议
---

## ➣ HTTPS 概念

![](https://nojsja.gitee.io/static-resources/images/interview/http-ssl.png)

HTTPS 是身披 SSL 外壳的 HTTP HTTPS 并非是应用层的一种新协议。只是 HTTP 通信接口部分用 SSL（Secure Socket Layer）和 TLS（Transport Layer Security）协议代替而已。

通常，HTTP 直接和 TCP 通信。当使用 SSL 时，则演变成先和 SSL 通信，再由 SSL 和 TCP 通信了。简言之，所谓 HTTPS，其实就是身披 SSL 协议这层外壳的 HTTP。

在采用 SSL 后，HTTP 就拥有了 HTTPS 的加密、证书和完整性保护这些功能。 SSL 是独立于 HTTP 的协议，所以不光是 HTTP 协议，其他运行在应用层的 SMTP 和 Telnet 等协议均可配合 SSL 协议使用。可以说 SSL 是当今世界上应用最为广泛的网络安全技术。

HTTPS 具有三个特性：

- 保密性：采用对称加密算法和不对称加密算法进行报文通信，非明文传输，通信过程具有保密性。
- 完整性：使用摘要算法生成摘要以供通信接收端验证数据完整性。
- 身份认证：使用数字证书验证服务端的真实身份和服务端公共密钥的正确性。

## ➣ HTTPS 数字证书业务流程

![](https://nojsja.gitee.io/static-resources/images/interview/https-process.jpg)

我们来介绍一下数字证书认证机构的业务流程。

首先，服务器的运营人员向数字证书认证机构提出公开密钥的申请。数字证书认证机构在判明提出申请者的身份之后，会使用自己的私钥对已申请的公开密钥做数字签名，然后分配这个已签名的公开密钥，并将该公开密钥放入公钥证书后绑定在一起。

服务器会将这份由数字证书认证机构颁发的公钥证书发送给客户端，以进行公开密钥加密方式通信。公钥证书也可叫做数字证书或直接称为证书。

接到证书的客户端可使用数字证书认证机构的公开密钥，对那张证书上的数字签名进行验证，一旦验证通过，客户端便可明确两件事：

- 认证服务器的公开密钥的是真实有效的数字证书认证机构；
- 服务器的公开密钥是值得信赖的，此处认证机关的公开密钥必须安全地转交给客户端；

使用该通信方式时，如何安全转交认证机关的公开密钥是一件很困难的事，因此，多数浏览器开发商发布版本时，会事先在内部植入常用认证机关的公开密钥。

## ➣ HTTPS 通信步骤

为了更好地理解  HTTPS，我们来观察一下 HTTPS 的通信步骤：

1. 通信步骤  客户端通过发送  Client  Hello  报文开始 SSL  通信。报文中包含客户端支持的  SSL 的指定版本、加密组件（Cipher  Suite）列表（所使用的加密算法及密钥长度等）。

2. 服务器可进行 SSL 通信时，会以 Server Hello 报文作为应答。和客户端一样，在报文中包含 SSL 版本以及加密组件。服务器的加密组件内容是从接收到的客户端加密组件内筛选出来的。
3. 之后服务器发送 Certificate 报文。报文中包含公开密钥证书。
4. 最后服务器发送 Server Hello Done 报文通知客户端，最初阶段的 SSL 握手协商部分结束。
5. SSL 第一次握手结束之后，客户端以 Client Key Exchange 报文作为回应。报文中包含通信加密中使用的一种被称为 Pre- master secret 的随机密码串。该报文已用步骤 3 中的公开密钥进行加密。
6. 接着客户端继续发送 Change Cipher Spec 报文。该报文会提示服务器，在此报文之后的通信会采用 Pre- master secret 密钥加密。
7. 客户端发送 Finished 报文。该报文包含连接至今全部报文的整体校验值。这次握手协商是否能够成功，要以服务器是否能够正确解密该报文作为判定标准。
8. 服务器同样发送 Change Cipher Spec 报文。
9. 服务器同样发送 Finished 报文。
10. 服务器和客户端的 Finished 报文交换完毕之后，SSL 连接就算建立完成。当然，通信会受到 SSL 的保护。从此处开始进行应用层协议的通信，即发送 HTTP 请求。
11. 应用层协议通信，即发送 HTTP 响应。
12. 最后由客户端断开连接。断开连接时，发送 close_ notify 报文。

在以上流程中，应用层发送数据时会附加一种叫做 MAC（Message Authentication Code）的报文摘要，摘要在发送之前会被共享密钥加密，通信对方收到之后会使用共享密钥解密，然后再运行一下摘要生成算法，对比生成的摘要和收到的解密的摘要是否一致。MAC 能够查知报文是否遭到篡改，从而保证报文的完整性。

## ➣ HTTPS 加密

HTTPS 采用共享密钥加密和公开密钥加密两者并用的混合加密机制。若密钥能够实现安全交换，那么有可能会考虑仅使用公开密钥加密来通信。但是公开密钥加密与共享密钥加密相比，其处理速度要慢。所以应充分利用两者各自的优势，将多种方法组合起来用于通信。在交换密钥环节使用公开密钥加密方式，之后的建立通信交换报文阶段则使用共享密钥加密方式。

#### 对称加密算法

就是加密和解密使用同一个密钥。如 AES、DES。加解密过程：

- 浏览器给服务器发送一个随机数 client-random 和一个支持的加密方法列表；
- 服务器给浏览器返回另一个随机数 server-random 和双方都支持的加密方法；
- 然后两者用加密方法将两个随机数混合生成密钥，这就是通信双上加解密的密钥；

问题是双方如何安全的传递两个随机数和加密方法，直接传给客户端，那过程中就很可能被窃取，别人就能成功解密拿到数据。

#### 不对称加密算法

就是一对密钥，有公钥 (public key) 和私钥(private key)，其中一个密钥加密后的数据，只能让另一个密钥进行解密。如 RSA、ECDHE。加解密过程：

- 浏览器给服务器发送一个随机数 client-random 和一个支持的加密方法列表；
- 服务器把另一个随机数 server-random、加密方法、公钥传给浏览器；
- 然后浏览器用公钥将两个随机数加密，生成密钥，这个密钥只能用私钥解密；

使用公钥反推出私钥是非常困难，但不是做不到，随着计算机运算能力提高，非对称密钥至少要 2048 位才能保证安全性，这就导致性能上要比对称加密要差很多

TLS 实际用的是两种算法的混合加密。通过 非对称加密算法 交换 对称加密算法 的密钥，交换完成后，再使用对称加密进行加解密传输数据。这样就保证了会话的机密性。过程如下：

- 浏览器给服务器发送一个随机数 client-random 和一个支持的加密方法列表；
- 服务器把另一个随机数 server-random、加密方法、公钥传给浏览器；
- 浏览器又生成另一个随机数 pre-random，并用公钥加密后传给服务器；
- 服务器再用私钥解密，得到 pre-random；
- 浏览器和服务器都将三个随机数用加密方法混合生成最终密钥；

这样即便被劫持，中间人没有私钥就拿不到 pre-random，就无法生成最终密钥。

可又有问题来了，如果一开始就被 DNS 截持，我们拿到的公钥是中间人的，而不是服务器的，数据还是会被窃取，所以会使用数字证书进行身份证和公钥验证。

#### 摘要算法

主要用于保证信息的完整性。常见的 MD5 算法、散列函数、哈希函数都属于这类算法，其特点就是单向性、无法反推原文

假如信息被劫持，并重新生成了摘要，这时候就判断不出来是否被篡改了，所以需要给摘要也通过会话密钥进行加密，这样就看不到明文信息，保证了安全性，同时也保证了完整性。