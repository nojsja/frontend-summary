<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.32">
    <title>● 项目架构梳理 | NoJsJa Frontend Summary</title><meta name="description" content="project 的描述">
    <link rel="modulepreload" href="/frontend-summary/assets/app.64694548.js"><link rel="modulepreload" href="/frontend-summary/assets/project.html.c1bc7c39.js"><link rel="modulepreload" href="/frontend-summary/assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="/frontend-summary/assets/project.html.2a29e769.js">
    <link rel="stylesheet" href="/frontend-summary/assets/style.c7eaaf18.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/frontend-summary/" class=""><img class="logo" src="https://nojsja.gitee.io/blogs/img/avatar/nojsja.jpeg" alt="NoJsJa Frontend Summary"><span class="site-name can-hide">NoJsJa Frontend Summary</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a class="external-link" href="https://nojsja.gitee.io/blogs" rel="noopener noreferrer" target="_blank" aria-label="Blogs"><!--[--><!--]--> Blogs <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/nojsja" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a class="external-link" href="https://nojsja.gitee.io/blogs" rel="noopener noreferrer" target="_blank" aria-label="Blogs"><!--[--><!--]--> Blogs <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/nojsja" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a href="/frontend-summary/" class="sidebar-item sidebar-heading" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/html_css" class="sidebar-item sidebar-heading" aria-label="➣ HTML/CSS 部分"><!--[--><!--]--> ➣ HTML/CSS 部分 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/frontend-summary/html_css/base.html" class="sidebar-item" aria-label="● 基础知识"><!--[--><!--]--> ● 基础知识 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/html_css/keys.html" class="sidebar-item" aria-label="● 考点梳理"><!--[--><!--]--> ● 考点梳理 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/frontend-summary/js" class="sidebar-item sidebar-heading" aria-label="➣ Javascript 部分"><!--[--><!--]--> ➣ Javascript 部分 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/frontend-summary/js/base.html" class="sidebar-item" aria-label="● 基础知识"><!--[--><!--]--> ● 基础知识 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/js/keys.html" class="sidebar-item" aria-label="● 考点梳理"><!--[--><!--]--> ● 考点梳理 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/frontend-summary/react" class="sidebar-item sidebar-heading" aria-label="➣ React 部分"><!--[--><!--]--> ➣ React 部分 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/frontend-summary/react/base.html" class="sidebar-item" aria-label="● 基础知识"><!--[--><!--]--> ● 基础知识 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/react/keys.html" class="sidebar-item" aria-label="● 考点梳理"><!--[--><!--]--> ● 考点梳理 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/frontend-summary/node" class="sidebar-item sidebar-heading" aria-label="➣ Node 部分"><!--[--><!--]--> ➣ Node 部分 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/frontend-summary/node/base.html" class="sidebar-item" aria-label="● 基础知识"><!--[--><!--]--> ● 基础知识 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/node/keys.html" class="sidebar-item" aria-label="● 考点梳理"><!--[--><!--]--> ● 考点梳理 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/frontend-summary/optimization" class="sidebar-item sidebar-heading" aria-label="➣ 前端性能优化"><!--[--><!--]--> ➣ 前端性能优化 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/frontend-summary/optimization/code.html" class="sidebar-item" aria-label="● 编码优化"><!--[--><!--]--> ● 编码优化 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/optimization/http.html" class="sidebar-item" aria-label="● http 优化"><!--[--><!--]--> ● http 优化 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/optimization/build.html" class="sidebar-item" aria-label="● 构建优化"><!--[--><!--]--> ● 构建优化 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/frontend-summary/structure" class="router-link-active sidebar-item sidebar-heading active" aria-label="➣ 前端工程化和架构"><!--[--><!--]--> ➣ 前端工程化和架构 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/frontend-summary/structure/base.html" class="sidebar-item" aria-label="● 基础知识"><!--[--><!--]--> ● 基础知识 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/structure/keys.html" class="sidebar-item" aria-label="● 考点梳理"><!--[--><!--]--> ● 考点梳理 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/frontend-summary/structure/project.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="● 项目架构梳理"><!--[--><!--]--> ● 项目架构梳理 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/frontend-summary/structure/project.html#➣-前公司-dview-项目的整体构成-dt" class="router-link-active router-link-exact-active sidebar-item" aria-label="➣ 前公司 dview 项目的整体构成 (dt)"><!--[--><!--]--> ➣ 前公司 dview 项目的整体构成 (dt) <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/frontend-summary/structure/project.html#➣-前公司-dview-项目的前端部分架构-dt" class="router-link-active router-link-exact-active sidebar-item" aria-label="➣ 前公司 dview 项目的前端部分架构 (dt)"><!--[--><!--]--> ➣ 前公司 dview 项目的前端部分架构 (dt) <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/frontend-summary/structure/project.html#➣-前公司-dview-项目采用-node-js-作为网关代理的原因-dt" class="router-link-active router-link-exact-active sidebar-item" aria-label="➣ 前公司 dview 项目采用 Node.js 作为网关代理的原因 (dt)"><!--[--><!--]--> ➣ 前公司 dview 项目采用 Node.js 作为网关代理的原因 (dt) <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/frontend-summary/structure/project.html#➣-前公司-cicd-系统的架构和原理-hz" class="router-link-active router-link-exact-active sidebar-item" aria-label="➣ 前公司 cicd 系统的架构和原理 (hz)"><!--[--><!--]--> ➣ 前公司 cicd 系统的架构和原理 (hz) <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/frontend-summary/structure/project.html#➣-im-系统-前端-sdk-的设计要点-hz" class="router-link-active router-link-exact-active sidebar-item" aria-label="➣ IM 系统 前端 SDK 的设计要点 (hz)"><!--[--><!--]--> ➣ IM 系统 前端 SDK 的设计要点 (hz) <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/frontend-summary/structure/project.html#一、整体设计" class="router-link-active router-link-exact-active sidebar-item" aria-label="一、整体设计"><!--[--><!--]--> 一、整体设计 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/frontend-summary/structure/project.html#二、通信协议" class="router-link-active router-link-exact-active sidebar-item" aria-label="二、通信协议"><!--[--><!--]--> 二、通信协议 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/frontend-summary/structure/project.html#三、消息交互逻辑描述" class="router-link-active router-link-exact-active sidebar-item" aria-label="三、消息交互逻辑描述"><!--[--><!--]--> 三、消息交互逻辑描述 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/frontend-summary/structure/project.html#五、sdk-整体使用流程" class="router-link-active router-link-exact-active sidebar-item" aria-label="五、SDK 整体使用流程"><!--[--><!--]--> 五、SDK 整体使用流程 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/frontend-summary/structure/project.html#➣-前端网关架构" class="router-link-active router-link-exact-active sidebar-item" aria-label="➣ 前端网关架构"><!--[--><!--]--> ➣ 前端网关架构 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/frontend-summary/structure/project.html#➣-前端-seo-优化" class="router-link-active router-link-exact-active sidebar-item" aria-label="➣ 前端 SEO 优化"><!--[--><!--]--> ➣ 前端 SEO 优化 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/frontend-summary/structure/project.html#spa-应用-seo-的优化方式" class="router-link-active router-link-exact-active sidebar-item" aria-label="SPA 应用 SEO 的优化方式"><!--[--><!--]--> SPA 应用 SEO 的优化方式 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/frontend-summary/structure/project.html#seo-的目的" class="router-link-active router-link-exact-active sidebar-item" aria-label="SEO 的目的"><!--[--><!--]--> SEO 的目的 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/frontend-summary/structure/project.html#seo-的优化方式" class="router-link-active router-link-exact-active sidebar-item" aria-label="SEO 的优化方式"><!--[--><!--]--> SEO 的优化方式 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><li><a href="/frontend-summary/network_system" class="sidebar-item sidebar-heading" aria-label="➣ 操作系统和网络"><!--[--><!--]--> ➣ 操作系统和网络 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/frontend-summary/network_system/base.html" class="sidebar-item" aria-label="● 基础知识"><!--[--><!--]--> ● 基础知识 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/network_system/keys.html" class="sidebar-item" aria-label="● 考点梳理"><!--[--><!--]--> ● 考点梳理 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/network_system/http.html" class="sidebar-item" aria-label="● HTTP 协议"><!--[--><!--]--> ● HTTP 协议 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/network_system/https.html" class="sidebar-item" aria-label="● HTTPS 协议"><!--[--><!--]--> ● HTTPS 协议 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/frontend-summary/design_pattern" class="sidebar-item sidebar-heading" aria-label="➣ 设计模式"><!--[--><!--]--> ➣ 设计模式 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/frontend-summary/design_pattern/decorator.html" class="sidebar-item" aria-label="● 装饰器模式"><!--[--><!--]--> ● 装饰器模式 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/design_pattern/flyweight.html" class="sidebar-item" aria-label="● 享元模式"><!--[--><!--]--> ● 享元模式 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/design_pattern/observer.html" class="sidebar-item" aria-label="● 观察者模式"><!--[--><!--]--> ● 观察者模式 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/design_pattern/proxy.html" class="sidebar-item" aria-label="● 代理模式"><!--[--><!--]--> ● 代理模式 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/design_pattern/responsibility_chain.html" class="sidebar-item" aria-label="● 责任链模式"><!--[--><!--]--> ● 责任链模式 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/design_pattern/state.html" class="sidebar-item" aria-label="● 状态模式"><!--[--><!--]--> ● 状态模式 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/design_pattern/strategy.html" class="sidebar-item" aria-label="● 策略模式"><!--[--><!--]--> ● 策略模式 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/design_pattern/template.html" class="sidebar-item" aria-label="● 模板方法模式"><!--[--><!--]--> ● 模板方法模式 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/frontend-summary/data" class="sidebar-item sidebar-heading" aria-label="➣ 数据结构"><!--[--><!--]--> ➣ 数据结构 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/frontend-summary/data/keys.html" class="sidebar-item" aria-label="● 考点梳理"><!--[--><!--]--> ● 考点梳理 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/data/base.html" class="sidebar-item" aria-label="● 基础知识"><!--[--><!--]--> ● 基础知识 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/frontend-summary/algorithms" class="sidebar-item sidebar-heading" aria-label="➣ 算法"><!--[--><!--]--> ➣ 算法 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/frontend-summary/algorithms/array.html" class="sidebar-item" aria-label="● 数组"><!--[--><!--]--> ● 数组 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/algorithms/dp.html" class="sidebar-item" aria-label="● 动态规划"><!--[--><!--]--> ● 动态规划 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/algorithms/linked_list.html" class="sidebar-item" aria-label="● 链表"><!--[--><!--]--> ● 链表 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/algorithms/string.html" class="sidebar-item" aria-label="● 字符串处理"><!--[--><!--]--> ● 字符串处理 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/algorithms/sort.html" class="sidebar-item" aria-label="● 排序算法"><!--[--><!--]--> ● 排序算法 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/algorithms/tree.html" class="sidebar-item" aria-label="● 树"><!--[--><!--]--> ● 树 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/algorithms/others.html" class="sidebar-item" aria-label="● 其它"><!--[--><!--]--> ● 其它 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h2 id="➣-前公司-dview-项目的整体构成-dt" tabindex="-1"><a class="header-anchor" href="#➣-前公司-dview-项目的整体构成-dt" aria-hidden="true">#</a> ➣ 前公司 dview 项目的整体构成 (dt)</h2><p>dview 是一个聚合服务云平台，内部包含很多子服务：</p><h4 id="_1-数据存储相关服务" tabindex="-1"><a class="header-anchor" href="#_1-数据存储相关服务" aria-hidden="true">#</a> 1. 数据存储相关服务</h4><ul><li>对象存储服务：基于 ceph s3 的对象存储服务，支持桶管理和桶内数据管理。</li><li>文件系统服务：文件系统的创建、挂载、卸载。</li><li>卷管理服务：也就是硬盘或者分区的管理，支持卷的快照、克隆、拷贝、删除等。</li><li>数据湖：基于对象存储，相比于对象存储，提升了架构扩展性：以集群服务节点为基本单位，可添加和移除多个集群的服务节点，每个节点内的对象存储桶作为基础存储单元，并辅以数据搜索引擎支持。提供桶内对象版本管理、桶对象查看、桶详情设置、桶对象元数据扩展这些功能。</li><li>存储池：基于卷存储，一个存储池以集群服务节点为基本单位，各个节点的卷作为基本存储单元，支持存储池扩容和所容和多种数据校验策略，各节点间会进行数据自动同步。</li></ul><h4 id="_2-用户相关服务" tabindex="-1"><a class="header-anchor" href="#_2-用户相关服务" aria-hidden="true">#</a> 2. 用户相关服务</h4><p>基于 keycloak 的用户认证和管理服务，有多租户的概念。</p><h4 id="_3-网络设置相关服务" tabindex="-1"><a class="header-anchor" href="#_3-网络设置相关服务" aria-hidden="true">#</a> 3. 网络设置相关服务</h4><p>网络部分分为：内网、数据同步网、外部网络。内网就是内部接口些用的网，web 访问也是这个；数据同步就是我们的集群节点之间互相同步数据用的；外部网络，就是业务网，上面说的高可用 IP 就是这个网，NAS 对象存储 SAN 都可以配置。</p><ul><li>节点管理服务：节点 ip、网卡设置。</li><li>高可用服务：保证集群节点在宕机后仍然能提供正常的服务，集群会进行 ip 漂移。</li></ul><h4 id="_4-监控相关服务" tabindex="-1"><a class="header-anchor" href="#_4-监控相关服务" aria-hidden="true">#</a> 4. 监控相关服务</h4><ul><li>节点管理服务：查看节点资源占用和基本设置等。</li><li>运维服务：支持节点重启、关机、服务状态、服务重启等。</li><li>日志服务：分为操作日志、审计日志、运行日志等。</li></ul><h2 id="➣-前公司-dview-项目的前端部分架构-dt" tabindex="-1"><a class="header-anchor" href="#➣-前公司-dview-项目的前端部分架构-dt" aria-hidden="true">#</a> ➣ 前公司 dview 项目的前端部分架构 (dt)</h2><p>重构之前</p><p>前端外层 nginx 负责客户端的访问控制，同时 nginx 作为 node 访问后端服务时的 router。</p><h4 id="前端" tabindex="-1"><a class="header-anchor" href="#前端" aria-hidden="true">#</a> 前端</h4><p>web static -&gt; nginx -&gt; node proxy -&gt; cluster nodes</p><h4 id="后端" tabindex="-1"><a class="header-anchor" href="#后端" aria-hidden="true">#</a> 后端</h4><p>云平台微服务</p><h2 id="➣-前公司-dview-项目采用-node-js-作为网关代理的原因-dt" tabindex="-1"><a class="header-anchor" href="#➣-前公司-dview-项目采用-node-js-作为网关代理的原因-dt" aria-hidden="true">#</a> ➣ 前公司 dview 项目采用 Node.js 作为网关代理的原因 (dt)</h2><p>web 静态资源由主机的 nginx 托管，提供给用户静态页面服务。</p><p>nodejs 作为一个业务网关的角色，相当于一个聚合服务，面向网页端提供统一的接口访问和权限控制。后端各个服务可能访问方式和返回的数据格式存在不统一性，因此 Node.js 这边还会进行一下统一处理，以规范网页端的 API 调用。</p><p>在对象存储和数据湖子项目中，Node.js 会承担请求签名的职责，前端通过 nodejs 来访问对象存储原生接口。</p><p>Node.js 在中间层也可以进入 mock 模式，将前端的接口转发到 yapi 接口模拟服务上，前端可以做到无缝开发和接口对接。</p><p>另一方面，该分布式存储产品大部分场景下，是以封闭的本地集群模式来访问的，不对外提供平台服务。因此需要支持 IP 直接访问集群节点的模式，因此 Node.js 也在这个场景下作为一个跳板机，解决了一些前端跨域访问的问题。</p><p>在其它方面，中间层还提供近期请求日志记录功能可以用于紧急排查问题。</p><h2 id="➣-前公司-cicd-系统的架构和原理-hz" tabindex="-1"><a class="header-anchor" href="#➣-前公司-cicd-系统的架构和原理-hz" aria-hidden="true">#</a> ➣ 前公司 cicd 系统的架构和原理 (hz)</h2><ol><li>底层基于 k8s 容器化，生产环境的应用可以在线缩容扩容服务节点，版本发布时可以做到无下线热替换。</li><li>有一个 k8s 服务创建界面，可以创建 <code>Java / Nodejs / Nodejs_static / Python / Static_web</code> 服务，之后这里创建的服务需要绑定到构建流水线。</li><li>每个项目可以创建自己的流水线并绑定之前创建的 k8s 微服务，流水线分为 <code>dev / test / preview / prod</code> 流水线。每次流水线构建完成之后会将打包结果生成为一个镜像，与应用绑定的 k8s 容器会引用这个最新的构建镜像。</li><li>有一个 nginx 配置系统，外层多个 nginx 服务指向不同的环境：<code>dev / test / preview / prod</code>，各个环境配置可以进行同步，并且每个环境下的可以配置很多子域名指向各个 k8s 应用。示例说明：一个不依赖于 Node 的 Static_web 前端项目 ，需要在某个环境下的 nginx 主域名下指定一个 <code>子域名</code> 与其绑定，具体操作就是将这个子域名 nginx 配置里面的 root 路径 <code>location /</code> 指向一个 nginx <code>upstream</code> 上游配置，这个上游配置即 k8s 内部 <code>Static_web</code> 服务对应集群容器内部 IP。另外可以配置 <code> 子域名 / api</code> 指向后端另一个 service 网关之类的微服务用于接口调用。</li><li>单个 k8s 实例容器内部可以自定义 nginx 的 <code>static file</code> 路径和其它配置等。</li></ol><h2 id="➣-im-系统-前端-sdk-的设计要点-hz" tabindex="-1"><a class="header-anchor" href="#➣-im-系统-前端-sdk-的设计要点-hz" aria-hidden="true">#</a> ➣ IM 系统 前端 SDK 的设计要点 (hz)</h2><h3 id="一、整体设计" tabindex="-1"><a class="header-anchor" href="#一、整体设计" aria-hidden="true">#</a> 一、整体设计</h3><p><img src="http://nojsja.gitee.io/static-resources/images/im/web_sdk_structure.png" alt="web_sdk_structure"></p><h4 id="_1-storage-存储" tabindex="-1"><a class="header-anchor" href="#_1-storage-存储" aria-hidden="true">#</a> 1. Storage 存储</h4><p>主要分为临时存储和持久化存储：</p><ul><li>临时数据：SDK 云信过程中产生的临时数据，比如会话列表、各种时间戳、token 等。</li><li>持久化数据：比如群消息已读状态回执、历史连接过的 appId、sessionId、导航数据等等。下文有详细说明。</li></ul><p>持久化存储方面也对低版本浏览器做了兼容：</p><ul><li><p>优先使用 LocalStorage</p></li><li><p>IE 早期版本采用 <code>Element#UserData</code> 方式兼容，原理就是浏览器将 DOM Element 作为存储容器，不过只是作为备用兼容方案，并不支持持久化。</p></li><li><p>兜底方案降级为 <code>MemoryStorage</code>，直接使用内存存储。这种方案下用户多次登录都需要重新获取所有数据，包括导航数据、自定义数据等，对用户的友好度降低。</p></li></ul><h4 id="_2-service-业务和服务" tabindex="-1"><a class="header-anchor" href="#_2-service-业务和服务" aria-hidden="true">#</a> 2. Service 业务和服务</h4><ul><li>[01] <strong>IM Client</strong>：作为一个装饰器对象对外提供 SDK 接口，大部分接口功能会实际调用 <code>Data Access Provider</code> 和 <code>Bridge</code> ，相当于对内部整体逻辑做了一层装饰器处理。</li><li>[02] <strong>Data Access Provider</strong>：负责大部分业务逻辑，会直接调用 Bridge 和 Storage。</li><li>[03] <strong>Bridge</strong>：将 IM Client 和 Msg Client 连接起来，设置监听者，内部 Client 的调用 Handler。 <ul><li>├─ Navigation：导航数据处理，获取用于建立服务器连接前的一些配置信息和定制化信息。</li><li>└─ Client：消息客户端，整个消息通信的中心，外部响应消息监听者，内部调用 Channel 通道进行消息通信。 <ul><li>├─ MessageHandler：消息接收和处理</li><li>└─ Channel：消息通道逻辑，会注册 <code>连接状态监听者</code> 和 <code>消息监听者</code>。 <ul><li>├─ Socket：通信载体对象，底层会调用 <code>WebSocket</code> 或 <code>Long Polling</code> 传输对象进行数据发送和接收。 <ul><li>├─ MessageOutputStream：在数据发送前会对明文请求消息数据进行 Header 定制和 <code>Stream</code> 流化编码处理。</li><li>└─ MessageInputStream：在数据接收前，会对 <code>Stream</code> 流化响应数据进行解码生成 SDK 直接使用的明文对象。</li></ul></li><li>├─ Listeners：连接状态监听器和消息监听器 <ul><li>├─ ConnectionStatusListener: 连接状态监听者</li><li>└─ ReceiveMessageListener: 消息接收监听者</li></ul></li></ul></li></ul></li></ul></li></ul><h4 id="_3-network-网络" tabindex="-1"><a class="header-anchor" href="#_3-network-网络" aria-hidden="true">#</a> 3. Network 网络</h4><blockquote><p>以 WebSocket 作为主要通信协议，HTTP 长轮询作为兼容方案，上传文件、下载文件、获取导航信息等会用到 HTTP 短连接用于即时数据的获取。</p></blockquote><p>需要注意的是整个通信过程中，Socket 传输的数据都是二进制数据，不会传明文，客户端发送消息时进行二进制编码，服务端接收消息时进行二进制解码。这样设计的目的一个是为了信息传送安全，另一个就是二进制数据有更好的传输性能。</p><h3 id="二、通信协议" tabindex="-1"><a class="header-anchor" href="#二、通信协议" aria-hidden="true">#</a> 二、通信协议</h3><h4 id="_1-主要方案-websocket" tabindex="-1"><a class="header-anchor" href="#_1-主要方案-websocket" aria-hidden="true">#</a> 1. 主要方案：WebSocket</h4><p>全双工的通信协议</p><h4 id="_2-兼容方案-http-长轮询" tabindex="-1"><a class="header-anchor" href="#_2-兼容方案-http-长轮询" aria-hidden="true">#</a> 2. 兼容方案：HTTP 长轮询</h4><p>（1）说明 1： HTTP 长连接 / 短连接</p><p>在 HTTP/1.0 中默认使用 http 短连接。也就是说，客户端和服务器每进行一次 HTTP 操作，就建立一次连接，任务结束就中断连接。当客户端浏览器访问的某个 HTML 或其他类型的 Web 页中包含有其他的 Web 资源（如 JavaScript 文件、图像文件、CSS 文件等），每遇到这样一个 Web 资源，浏览器就会重新建立一个 HTTP 会话。</p><p>而从 HTTP/1.1 起，默认使用长连接，用以保持连接特性，提高传输的效率和减低服务器的开销。使用长连接的 HTTP 协议，会在响应头加入这行代码：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>Connection:keep-alive
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>在使用长连接的情况下，当一个网页打开完成后，客户端和服务器之间用于传输 HTTP 数据的 TCP 连接不会关闭，客户端再次访问这个服务器时，会继续使用这一条已经建立的连接。Keep-Alive 不会永久保持连接，它有一个保持时间，可以在不同的服务器软件（如 Apache）中设定这个时间。实现长连接需要客户端和服务端都支持长连接。</p><p>HTTP 协议的长连接和短连接，实质上是 TCP 协议的长连接和短连接。</p><p>（2）说明 2：HTTP 长轮询</p><p>HTTP 长轮询是人为编程实现的一种通信方式，它在短轮询的基础上加入服务端的连接保持、连接超时和数据变化监听等功能。而 HTTP 长连接本质上是 http 协议的特性，主要用于优化客户端的连接重用，减少资源占用，不可人为编程。</p><h4 id="_3-通信数据格式" tabindex="-1"><a class="header-anchor" href="#_3-通信数据格式" aria-hidden="true">#</a> 3. 通信数据格式</h4><p>每个通信消息都由 header + body 编码方式 + body 构成，采用二进制字节流进行传输：</p><ul><li><p><strong>header</strong>：用于运算的 int8 数字，header 部分采用自定义算法进行编解码。header 即一个 <code>int8</code> 数字 (占 8bit，范围 0-255) 表示各种具有不同参数的 header 实例。位于消息体第一个字节。</p></li><li><p><strong>编码方式</strong>：用于表示 body 体具体使用的 protobuf 编码方式，因为可能同一种消息存在多个编码方式，比如 QueryAckMessage 可能会根据 QueryMessage 指定的内容返回会话列表、新消息列表或历史消息列表等等。位于消息体第二个字节。</p></li><li><p><strong>body</strong>：二进制字节流数据，会使用某种 protobuf 编码方式解析。与常见的 xml 和 json 数据类型不同，xml 和 json 只会把具有一定内容组织的数据格式编码成字符串，然后把明文字符串交给底层的加密层、传输层进行处理和分包之类的。而 Protobuf 是把数据通过独特的 key 映射方式压缩成更短的 byte 流再交给传输层进行传输。</p></li></ul><p>Protocol Buffer 在传输过程中其实只会传输四个信息，分别是：</p><ul><li>** 类型（string, int...)**</li><li>** 字段映射的值（也就是 tag，也叫 key，在 proto 文件中定义）**</li><li>**value 长度 **</li><li>**value 本身 **</li></ul><p>简要描述： <code>00001(tag/key) 111(type) 00000011 (length:3B) 3bytes(value)</code>，第一个字节 3bit 解析为数据类型 type (int/string...)，第一个字节前 5bit 使用算法解析为 proto 中定义的 各种 key；紧接着一个字节如果高位为 1，则表示后面紧接着的字节也表示 value 长度，如果紧接着的字节高位为 0 则当前字节表示 value 长度；最后根据前一步得到的 value 长度截取 value 值。</p><p>值得注意的是很多枚举类型的 value 值前后端也有一定的码值规则进行映射。protobuf 和 value 码值都起到了压缩消息体的作用，其实 header 也有压缩算法，可以参考以下说明。</p><p><img src="https://nojsja.gitee.io/static-resources/images/interview/protobuf.jpg" alt=""></p><ul><li><p>[01] body 部分采用 <code>protobuf</code> 格式 (protocol buffer) 进行数据编码传输和解码</p><ul><li>protobuf 是谷歌的一种开源、跨平台的序列化数据格式，其中 proto 文件用于描述数据结构，将冗长的明文字段映射为简短的值表示。</li><li>proto 文件内部会定义各种 message 结构体，每个结构体会有各个映射字段。比如 <code>optional int32 page_number = 2;</code> 表示可选的 int32 字段 page_number，映射值为 2，消息体解码的时候就会把 tag 位为 2 的数据解析为字段 page_number 并作为 key，然后紧接着再解码动态的 length 位，得到后面有多少个字节的 value 数据，最终 key / value 均被解析。</li><li>SDK 发送消息时每个消息体会存在多个 <code>key/value</code> 字段作为参数，各个映射字段的作用就是压缩通信过程中 <code>key/value</code> 键值对中 key 的明文定义，并且 value 部分包括中英文、数字、字符、特殊符号等也会根据 ascii 编码转化为二进制字节流传输。</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>  message SearchRequest <span class="token punctuation">{</span>
    required string query <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    optional int32 page_number <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    optional int32 result_per_page <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>公共定义的 <code>proto</code> 规则文件可以编译生成各个语言的 lib 库文件，包括生成前端需要的 js lib，SDK 客户端使用 lib 进行消息的编解码。</li><li>值得注意的是每种类型的消息，有一些属于 SDK 内部使用的字段，他们会按照约定存放在 body 体靠前面数个字节中，这些字段值会先被解析出来，然后剩下的其余字节数据再交由 protobuf lib 库对消息内容本身进行解码。</li><li>传输过程中使用 arraybuffer，客户端 SDK 拿到消息数据后，会使用 arraybuffer 生成 Uint8Array 即 8 位无符号整数数组，生成之后根据每种消息实例调用自身的 readMessage 来读取上面一条描述的内部消息字段。解码完内部消息字段后，具体消息内容会调用 protobuf lib 库进行解码。</li><li>Uint8Array 数组每一位数表示一个字节，需要先转化各位为 16 进制，再由 16 进制转化为其它 utf-8 字符或数字等。以我们在转化一个时间戳参数 timestrap 为例：时间戳由于很大一般由 8 个字节表示，因此读取 Uint8Array 中的 8 个数字，每个转换为 16 进制数，然后再把这些 16 进制连接为一个字符串，最后再把 16 进制数字符串 parseInt 转换为 10 进制的时间戳。其它大部分数据直接通过 utf-8 解码方式获取即可，utf-8 是一种变长的编码方式，是 unicode 编码的一种具体实现。</li><li>utf-8 编码的转换在 js 中需要使用两个方法：<code>String.fromCharCode()</code> 和 <code>String.prototype.charCodeAt()</code>。</li><li>数据编码和转换原理就是：int8 数字一个占用一个字节，一个 int8 数字转换为一个 16 进制，多个 16 进制组合为一个大的 16 进制字符串， 16 进制字符串 -&gt; 10 进制数字 -&gt; 对应 unicode 编码对应的真实明文字符。比如：&quot;严&quot; 的 unicode 编号 <code>(&#39;严&#39;).charCodeAt(0) === 20005</code>。</li><li>整体流程表示为：<code>明文 -&gt; arraybuffer -&gt; websoket 传输 -&gt; arraybuffer -&gt; Uint8Array -&gt; defined parse step1 -&gt; protobuf parser step2 -&gt; 明文</code>。</li></ul></li><li><p>[02] header 部分使用自定义算法进行编码解码</p><ul><li>每条消息的 header 通常会有一些标志位，比如：是否需要回执 (QOS)、客户端是否需要持久化、本条消息是否是重发消息、消息类型等。如果明文传输，通常会增加通信成本。我们制定了 header 标志位中每位的运算规则，然后用一个 int8 数字表示 header(占用一个字节)，header 数字经过各种约定的运算后在客户端和服务器端都可以生成一致的各标志位 value。</li><li>运算规则：</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>  <span class="token keyword">const</span> Qos <span class="token operator">=</span> <span class="token punctuation">{</span>

      <span class="token constant">AT_MOST_ONCE</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 最多一次</span>

      <span class="token constant">AT_LEAST_ONCE</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 至少一次</span>

      <span class="token constant">EXACTLY_ONCE</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// 必须一次</span>

      <span class="token constant">DEFAULT</span><span class="token operator">:</span> <span class="token number">3</span> <span class="token comment">// 默认</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">class</span> <span class="token class-name">Header</span> <span class="token punctuation">{</span>
      type <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>
      retain <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>
      qos <span class="token operator">=</span> Qos<span class="token punctuation">.</span><span class="token constant">AT_LEAST_ONCE</span>
      dup <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>
      syncMsg <span class="token operator">=</span> <span class="token string">&#39;&#39;</span>
      <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">_type<span class="token punctuation">,</span> _retain<span class="token punctuation">,</span> _qos<span class="token punctuation">,</span> _dup</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>_type <span class="token operator">&amp;&amp;</span> <span class="token operator">+</span>_type <span class="token operator">==</span> _type <span class="token operator">&amp;&amp;</span> arguments<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> _type<span class="token punctuation">;</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>retain <span class="token operator">=</span> _retain<span class="token punctuation">;</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>qos <span class="token operator">=</span> _qos<span class="token punctuation">;</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>dup <span class="token operator">=</span> _dup<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token function">getSyncMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>syncMsg<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>type<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">decode</span><span class="token punctuation">(</span><span class="token parameter">_type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>retain <span class="token operator">=</span> <span class="token punctuation">(</span>_type <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 奇数</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>qos <span class="token operator">=</span> <span class="token punctuation">(</span>_type <span class="token operator">&amp;</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>dup <span class="token operator">=</span> <span class="token punctuation">(</span>_type <span class="token operator">&amp;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token punctuation">(</span>_type<span class="token operator">&gt;&gt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">15</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>syncMsg <span class="token operator">=</span> <span class="token punctuation">(</span>_type <span class="token operator">&amp;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">var</span> me <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
          <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>qos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">case</span> <span class="token string">&#39;AT_MOST_ONCE&#39;</span><span class="token operator">:</span>
                  me<span class="token punctuation">.</span>qos <span class="token operator">=</span> Qos<span class="token punctuation">.</span><span class="token constant">AT_MOST_ONCE</span><span class="token punctuation">;</span> <span class="token comment">// 0</span>
                  <span class="token keyword">break</span><span class="token punctuation">;</span>
              <span class="token keyword">case</span> <span class="token string">&#39;AT_LEAST_ONCE&#39;</span><span class="token operator">:</span>
                  me<span class="token punctuation">.</span>qos <span class="token operator">=</span> Qos<span class="token punctuation">.</span><span class="token constant">AT_LEAST_ONCE</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
                  <span class="token keyword">break</span><span class="token punctuation">;</span>
              <span class="token keyword">case</span> <span class="token string">&#39;EXACTLY_ONCE&#39;</span><span class="token operator">:</span>
                  me<span class="token punctuation">.</span>qos <span class="token operator">=</span> Qos<span class="token punctuation">.</span><span class="token constant">EXACTLY_ONCE</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
                  <span class="token keyword">break</span><span class="token punctuation">;</span>
              <span class="token keyword">case</span> <span class="token string">&#39;DEFAULT&#39;</span><span class="token operator">:</span>
                  me<span class="token punctuation">.</span>qos <span class="token operator">=</span> Qos<span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
                  <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">var</span> _byte <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          _byte <span class="token operator">|=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>retain <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
          _byte <span class="token operator">|=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>qos <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
          _byte <span class="token operator">|=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dup <span class="token operator">?</span> <span class="token number">8</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> _byte<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token string">&quot;Header [type=&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">+</span> <span class="token string">&quot;,retain=&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>retain <span class="token operator">+</span> <span class="token string">&quot;,qos=&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>qos <span class="token operator">+</span> <span class="token string">&quot;,dup=&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dup <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div></li></ul><h4 id="_4-数据加密流程" tabindex="-1"><a class="header-anchor" href="#_4-数据加密流程" aria-hidden="true">#</a> 4. 数据加密流程</h4><p>protobuf 自带一定的加密特性，并且传输过程中为非明文。</p><h3 id="三、消息交互逻辑描述" tabindex="-1"><a class="header-anchor" href="#三、消息交互逻辑描述" aria-hidden="true">#</a> 三、消息交互逻辑描述</h3><p>SDK 内部消息类型定义：</p><ul><li>ConnectMessage：请求连接消息 (发向客户端)</li><li>ConnAckMessage：连接应答消息类型，服务器连接成功后收到 (发向客户端)</li><li>QueryAckMessage：请求查询消息应答 (发向客户端，携带查询结果)</li><li>QueryConMessage：请求查询消息回执 (发向服务器，表明已收到查询结果)</li><li>PingReqMessage：心跳请求消息信令 (双向，用于心跳检测和 Socket 验活)</li><li>PingRespMessage：心跳响应消息信令 (发往客户端)</li><li>DisconnectMessage：断开连接消息 (发往客户端)</li><li>PublishMessage：聊天消息，客户端发布或收到此类消息 (双向) <ul><li>s_ntf：系统通知消息</li><li>s_msg：聊天消息</li><li>s_stat：用户状态更新消息</li><li>s_cmd：聊天室消息</li><li>pp/pd/ch/pc：群组消息</li></ul></li><li>PubAckMessage: 发送聊天消息应答。某些消息发送之后要求服务端接收时回发回执消息，同样的收到某些消息后，客户端会往服务端发送回执消息。(双向)</li></ul><h4 id="_1-历史消息-会话" tabindex="-1"><a class="header-anchor" href="#_1-历史消息-会话" aria-hidden="true">#</a> 1. 历史消息 (会话)</h4><p>历史消息是针对某一个会话的，根据会话中的某条消息时间戳，可以向上或向下查询历史消息。</p><h4 id="_2-离线消息-全局" tabindex="-1"><a class="header-anchor" href="#_2-离线消息-全局" aria-hidden="true">#</a> 2. 离线消息 (全局)</h4><blockquote><p>离线消息就是用户不在线时，服务端存储的消息，需要在用户上线的时候由手动调用 SDK 拉取，SDK 会每隔 180s 向服务端发送消息拉取离线消息。</p></blockquote><p>SDK 连接服务器成功后，会自动拉取一次离线消息 (<code>QueryMessage</code> - pullMsg)，客户端断开连接后重连时也会调用。</p><p>注意离线消息和历史消息不一样的是，历史消息是针对用户的，SDK 调用者在会话中会主动拉取历史消息。</p><p>而离线消息是 SDK 自发的一种消息机制，一方面防止网络波动和其它情况下的消息丢失，另一方面可以在用户上线时自动获取服务器的离线消息，它不属于用户 (SDK 调用者) 行为。</p><h4 id="_3-心跳消息" tabindex="-1"><a class="header-anchor" href="#_3-心跳消息" aria-hidden="true">#</a> 3. 心跳消息</h4><p>SDK 会每隔 30s 向服务端发送心跳包 <code>PingReqMessage</code>，用于保持连接。服务端需要回传 <code>PingRespMessage</code> 用于响应。同时服务器端也是通过这个过程来确定客户端是否在线，因为活跃的客户端一定会每隔 30s 向服务器发送心跳包，断线的用户收到的消息会被离线处理。</p><h4 id="_4-用户初次加载界面后" tabindex="-1"><a class="header-anchor" href="#_4-用户初次加载界面后" aria-hidden="true">#</a> 4. 用户初次加载界面后</h4><p>需要使用 <code>QueryMessage</code> - qryCon 拉取所有会话，每个会话都有未读消息数量和最后一条未读消息内容。</p><p>首次拉取离线消息和首次列举会话并不冲突，如果首次拉取的离线消息先到达，会先根据某些离线消息来创建某几个本地会话。而列举会话请求返回后也会直接利用前面创建的会话，属于 SDK 自发的逻辑。</p><p>之后 SDK 主动拉取离线消息 (消息心跳，需要区别于 ping 心跳) 或是收到消息通知后拉取在线消息时，SDK 调用者需要根据每条消息所属的会话对会话列表做更新。</p><h4 id="_5-聊天界面" tabindex="-1"><a class="header-anchor" href="#_5-聊天界面" aria-hidden="true">#</a> 5. 聊天界面</h4><ol><li>进入聊天界面：将最新的消息设置为已读 (通过 <code>PublishMessage</code> 的方式发送，同时会收到服务器端的发送回执 <code>PubAckMessage</code>)。</li><li>输入信息：聚焦时发送 <code>sendTypingStatusMessage</code> 表明正在输入。</li><li>点击发送文本：向后端发送 <code>PublishMessage</code> - ppMsgP 信息。</li></ol><h4 id="_6-发送消息整体流程" tabindex="-1"><a class="header-anchor" href="#_6-发送消息整体流程" aria-hidden="true">#</a> 6. 发送消息整体流程</h4><ol><li>客户端向服务器发送 <code>PublishMessage</code> - ppMsgP 消息。</li><li>服务端收到后向消息发送端发一条 <code>PubAckMessage</code> 消息表明消息发送成功。</li><li>服务器开始进行消息转发，如果接收方不在线，则将消息存储为离线消息。如果接收方在线，则服务器先向接收端发送 <code>PublishMessage</code> - s_ntf 用于通知有消息到达。另一种情况时恰好此时接收端正在查询消息列表，那么此消息数据也可能由一条 <code>QueryAckMessage</code> 响应带回。</li><li>消息接收端成功接收新消息通知 <code>PublishMessage</code> - s_ntf 后，再向服务端发送 <code>QueryMessage</code> - pullMsg 用于拉取消息，服务器端接收到拉取消息请求，将消息数据通过 <code>QueryAckMessage</code> 消息发送给消息接收端，然后消息接收端收到后向服务端发送 <code>QueryConMessage</code> 消息表明成功接收。</li><li>另外如果此时接收端正在在聊天界面则会继续向服务器发送已读回执，回执通过 <code>PublishMessage</code> 格式发出 (参数见下方描述)。</li><li>服务器端拿到已读回执做数据处理后，向消息接收端发出 <code>PubAckMessage</code> 消息表明已读回执已经成功处理，最后向消息发送端发送 <code>PublishMessage</code> 用于表示消息已经被接收端读取。</li><li>消息发送端拿到最后的 <code>PublishMessage</code> 信息将本地的消息状态更新为对方已读，并向服务器发送 <code>PubAckMessage</code> - s_msg 表明已处理。</li></ol><h4 id="_7-发送消息整体流程-补充" tabindex="-1"><a class="header-anchor" href="#_7-发送消息整体流程-补充" aria-hidden="true">#</a> 7. 发送消息整体流程 (补充)</h4><p>在处理消息转发的时候，会有一定的动态机制。当用户有很多消息积压时，服务端会下发通知让接收端一次性拉取消息，而不是直接向接收端发送 <code>PublishMessag</code> 逐条传输消息数据。</p><h4 id="_8-查询消息流程" tabindex="-1"><a class="header-anchor" href="#_8-查询消息流程" aria-hidden="true">#</a> 8. 查询消息流程</h4><ol><li>客户端向服务器发送 <code>QueryMessage</code> 消息 (离线消息 / 历史消息)。</li><li>服务器统计消息数量，向消息查询客户端发送 <code>QueryAckMessage</code> 携带所有消息。</li><li>某些消息客户端收到后，需要向服务端回发 <code>QueryConMessage</code> 表明所查询的消息已经成功接收。</li></ol><h4 id="_9-发送方发消息流程" tabindex="-1"><a class="header-anchor" href="#_9-发送方发消息流程" aria-hidden="true">#</a> 9. 发送方发消息流程</h4><p>发送 <code>PublishMessage-ppMsgP</code> (私聊个人消息)，然后收到服务器 <code>PubAckMessage</code> 表明发送成功。</p><h4 id="_10-接收方收消息流程" tabindex="-1"><a class="header-anchor" href="#_10-接收方收消息流程" aria-hidden="true">#</a> 10. 接收方收消息流程</h4><ol><li>收到 <code>PublishMessage-s_ntf</code> 消息通知，接收方发出 <code>QueryMessage-pullMsg</code> 请求拉取消息。</li><li>服务器向客户端发送 <code>QueryAckMessage</code> 用于传输消息数据</li><li>客户端接收消息后向服务器发送 <code>QueryConMessage</code> 表示接收成功。</li><li>如果用户在聊天界面，还会发出已读信息 <code>PublishMessag-s_msg</code> 将消息标注为已读，该消息内容为：</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    lastMessageSendTime<span class="token operator">:</span> <span class="token number">1642668752031</span> <span class="token comment">// 被标注已读的消息发送时间</span>
    messageName<span class="token operator">:</span> <span class="token string">&quot;ReadReceiptMessage&quot;</span> <span class="token comment">// 固定</span>
    messageUId<span class="token operator">:</span> <span class="token string">&quot;BUEQ-NVP7-IQE6-81KB&quot;</span> <span class="token comment">// 被标注已读的消息发送时间 UID</span>
    type<span class="token operator">:</span> <span class="token number">1</span> <span class="token comment">// conversation type</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="_11-ack-响应消息是怎样和请求消息的处理流程建立联系的" tabindex="-1"><a class="header-anchor" href="#_11-ack-响应消息是怎样和请求消息的处理流程建立联系的" aria-hidden="true">#</a> 11. Ack 响应消息是怎样和请求消息的处理流程建立联系的</h4><p>首先理清一个概念，messageId 和 messageUId，messageId 是前端需要的一个临时性的唯一 Id，在用户登录到 IM 软件到退出会话的整个流程中需要保证是唯一的。而 messageUId 是后端具体存储的可以用于指代和查询某条消息的唯一真实 ID，在后端存储中它也是唯一不可重复的。</p><p>通常 SDK 发出一个查询消息，后端之后会异步返回另一条消息来送回查询数据，这整个过程是完全独立的，而不是像 Axios 请求库一样，发出请求后拿到一个 Promise 响应后拿到请求结果。Websocket 是全双工的，消息之间不能根据顺序进行一一对应，因此前端的 messageId 是用于建立两条相互关联的请求 / 响应消息的脐带。换而言之后端在返回数据的响应中也会有之前请求的 messageId，他们值是相同的。</p><h3 id="五、sdk-整体使用流程" tabindex="-1"><a class="header-anchor" href="#五、sdk-整体使用流程" aria-hidden="true">#</a> 五、SDK 整体使用流程</h3><p>基础概念说明：</p><ul><li>appKey：应用的唯一标识 (可能不需要实现)</li><li>userId ：用户的唯一标识</li><li>token ：用户的通信凭证</li></ul><h4 id="_1-获取应用的-appkey-appsecret" tabindex="-1"><a class="header-anchor" href="#_1-获取应用的-appkey-appsecret" aria-hidden="true">#</a> 1. 获取应用的 appKey / appSecret</h4><p>如果要作为一个云平台是公开对外公开提供服务的，类似于微信小程序的概念的话。appKey 可以用于区分云平台不同的开发者的应用，以提供每个开发者独立的服务。</p><p>早期简单实现可以只考虑一个开发者，也就是个 appKey / appSecret 固定，不用需要动态分发给不同的开发者。</p><h4 id="_2-前端通过-app-应用服务器接口获取-token" tabindex="-1"><a class="header-anchor" href="#_2-前端通过-app-应用服务器接口获取-token" aria-hidden="true">#</a> 2. 前端通过 App 应用服务器接口获取 token</h4><blockquote><p>开发环境下，为了方便开发者调试，可以使用可用的测试 token。SDK 调用者固定传入测试 token，以测试正常流程。</p></blockquote><p>token 作为用户使用 IM 系统时通信的凭证，用于验证用户身份，以及用户的消息接收和发送。</p><p>流程图：</p><p><img src="http://nojsja.gitee.io/static-resources/images/im/get_token.png" alt="get_token"></p><p>（1）客户端向 <strong>应用服务器</strong> 发送请求，请求携带 userId、appKey 等参数。</p><p>（2）应用服务器拿到请求后，使用步骤一拿到的 appSecret，根据签名算法使用 &quot;<strong>appSecret + 随机数 (从前端请求拿到) + timestrap(从前端请求拿到)</strong>&quot; 生成签名 <strong>signature</strong>，然后使用 <code>appKey + 随机数 + timestrap + signature</code> 作为参数向 <strong>API 服务器</strong> 发送请求，获取用户 token。拿到 token 后应用服务器会将其存入数据库，最后 token 作为 http 请求结果并返回给客户端。（这里有个概念就是区分了 API 服务器和应用服务器，如果简化架构的话应用服务器和 API 服务器可以为同一个服务器）。</p><p>（3）客户端拿到的 token 后存储 token 数据，之后客户端直接使用 token 跟 IM 消息服务器通信，API 服务器只会用于用户的某次会话中最初的 token 获取。</p><p>（4）对于后续客户端获取 token 的请求，App 应用服务器直接从数据库中返回之前从 API 服务器拿到的 token。进而流程简化为：</p><p><img src="http://nojsja.gitee.io/static-resources/images/im/get_token_cache.png" alt="get_token_cache"></p><h4 id="_3-客户端对-token-的本地化处理" tabindex="-1"><a class="header-anchor" href="#_3-客户端对-token-的本地化处理" aria-hidden="true">#</a> 3. 客户端对 token 的本地化处理</h4><p>客户端获取到 token 后，可以直接使用 token 跟应用服务器、消息服务器通信。对 token 做本地持久化存储支持后，客户端也可自行实现自动登录和登录过期逻辑。</p><p><img src="http://nojsja.gitee.io/static-resources/images/im/client_token.png" alt="client_token"></p><h4 id="_4-客户端和-im-消息服务端进行业务通信" tabindex="-1"><a class="header-anchor" href="#_4-客户端和-im-消息服务端进行业务通信" aria-hidden="true">#</a> 4. 客户端和 IM 消息服务端进行业务通信</h4><h5 id="_1-客户端初始化-sdk" tabindex="-1"><a class="header-anchor" href="#_1-客户端初始化-sdk" aria-hidden="true">#</a> （1）客户端初始化 sdk</h5><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>RongIMLib<span class="token punctuation">.</span>RongIMClient<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>appkey<span class="token punctuation">,</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h5 id="_2-客户端设置状态监听器和消息监听器" tabindex="-1"><a class="header-anchor" href="#_2-客户端设置状态监听器和消息监听器" aria-hidden="true">#</a> （2）客户端设置状态监听器和消息监听器</h5><p>必须设置监听器后，再连接 IM 消息服务器，示例代码如下：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* 连接状态监听器 */</span>
RongIMClient<span class="token punctuation">.</span><span class="token function">setConnectionStatusListener</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">onChanged</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">status</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// status 标识当前连接状态</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> RongIMLib<span class="token punctuation">.</span>ConnectionStatus<span class="token punctuation">.</span><span class="token constant">CONNECTED</span><span class="token operator">:</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;链接成功&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> RongIMLib<span class="token punctuation">.</span>ConnectionStatus<span class="token punctuation">.</span><span class="token constant">CONNECTING</span><span class="token operator">:</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;正在链接&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> RongIMLib<span class="token punctuation">.</span>ConnectionStatus<span class="token punctuation">.</span><span class="token constant">DISCONNECTED</span><span class="token operator">:</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;断开连接&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> RongIMLib<span class="token punctuation">.</span>ConnectionStatus<span class="token punctuation">.</span><span class="token constant">KICKED_OFFLINE_BY_OTHER_CLIENT</span><span class="token operator">:</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;其他设备登录&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> RongIMLib<span class="token punctuation">.</span>ConnectionStatus<span class="token punctuation">.</span><span class="token constant">DOMAIN_INCORRECT</span><span class="token operator">:</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;域名不正确&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> RongIMLib<span class="token punctuation">.</span>ConnectionStatus<span class="token punctuation">.</span><span class="token constant">NETWORK_UNAVAILABLE</span><span class="token operator">:</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;网络不可用&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* 消息监听器 */</span>
RongIMClient<span class="token punctuation">.</span><span class="token function">setOnReceiveMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// 接收到的消息</span>
    <span class="token function-variable function">onReceived</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 判断消息类型</span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>messageType<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">case</span> RongIMClient<span class="token punctuation">.</span>MessageType<span class="token punctuation">.</span>TextMessage<span class="token operator">:</span>
                <span class="token comment">// message.content.content =&gt; 文字内容</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> RongIMClient<span class="token punctuation">.</span>MessageType<span class="token punctuation">.</span>VoiceMessage<span class="token operator">:</span>
                <span class="token comment">// message.content.content =&gt; 格式为 AMR 的音频 base64</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> RongIMClient<span class="token punctuation">.</span>MessageType<span class="token punctuation">.</span>ImageMessage<span class="token operator">:</span>
                <span class="token comment">// message.content.content =&gt; 图片缩略图 base64</span>
                <span class="token comment">// message.content.imageUri =&gt; 原图 URL</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> RongIMClient<span class="token punctuation">.</span>MessageType<span class="token punctuation">.</span>LocationMessage<span class="token operator">:</span>
                <span class="token comment">// message.content.latiude =&gt; 纬度</span>
                <span class="token comment">// message.content.longitude =&gt; 经度</span>
                <span class="token comment">// message.content.content =&gt; 位置图片 base64</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> RongIMClient<span class="token punctuation">.</span>MessageType<span class="token punctuation">.</span>RichContentMessage<span class="token operator">:</span>
                <span class="token comment">// message.content.content =&gt; 文本消息内容</span>
                <span class="token comment">// message.content.imageUri =&gt; 图片 base64</span>
                <span class="token comment">// message.content.url =&gt; 原图 URL</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> RongIMClient<span class="token punctuation">.</span>MessageType<span class="token punctuation">.</span>InformationNotificationMessage<span class="token operator">:</span>
                <span class="token comment">// do something</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> RongIMClient<span class="token punctuation">.</span>MessageType<span class="token punctuation">.</span>ContactNotificationMessage<span class="token operator">:</span>
                <span class="token comment">// do something</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> RongIMClient<span class="token punctuation">.</span>MessageType<span class="token punctuation">.</span>ProfileNotificationMessage<span class="token operator">:</span>
                <span class="token comment">// do something</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> RongIMClient<span class="token punctuation">.</span>MessageType<span class="token punctuation">.</span>CommandNotificationMessage<span class="token operator">:</span>
                <span class="token comment">// do something</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> RongIMClient<span class="token punctuation">.</span>MessageType<span class="token punctuation">.</span>CommandMessage<span class="token operator">:</span>
                <span class="token comment">// do something</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> RongIMClient<span class="token punctuation">.</span>MessageType<span class="token punctuation">.</span>UnknownMessage<span class="token operator">:</span>
                <span class="token comment">// do something</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token comment">// do something</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br></div></div><h5 id="_3-客户端连接服务器" tabindex="-1"><a class="header-anchor" href="#_3-客户端连接服务器" aria-hidden="true">#</a> （3）客户端连接服务器</h5><p>连接消息服务器必须在执行 <code>RongIMLib.RongIMClient.init(appkey);</code> 之后调用，除监听以外所有方法都必须在调用 connect 连接服务器成功之后再调用。</p><ul><li>dev 开发环境下客户端可以直接写死 token 测试</li><li>prod 生产环境下需要通过 <code> 应用服务器 (App Server)</code> 获取 token</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 本地调试写死或者通过应用服务器获取，dev/prod 的两种处理方式</span>
<span class="token keyword">var</span> token <span class="token operator">=</span> <span class="token string">&quot;mKmyKqTSf7aNDinwAFMnz7NXKILeV3X0+CAKgQ==&quot;</span><span class="token punctuation">;</span>

RongIMClient<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">onSuccess</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">userId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Connect successfully.&#39;</span> <span class="token operator">+</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">onTokenIncorrect</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;token 无效&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">onError</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">errorCode</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> info <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>errorCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> RongIMLib<span class="token punctuation">.</span>ErrorCode<span class="token punctuation">.</span><span class="token constant">TIMEOUT</span><span class="token operator">:</span>
                info <span class="token operator">=</span> <span class="token string">&#39;超时&#39;</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> RongIMLib<span class="token punctuation">.</span>ConnectionState<span class="token punctuation">.</span><span class="token constant">UNACCEPTABLE_PAROTOCOL_VERSION</span><span class="token operator">:</span>
                info <span class="token operator">=</span> <span class="token string">&#39;不可接受的协议版本&#39;</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> RongIMLib<span class="token punctuation">.</span>ConnectionState<span class="token punctuation">.</span><span class="token constant">IDENTIFIER_REJECTED</span><span class="token operator">:</span>
                info <span class="token operator">=</span> <span class="token string">&#39;appkey 不正确&#39;</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> RongIMLib<span class="token punctuation">.</span>ConnectionState<span class="token punctuation">.</span><span class="token constant">SERVER_UNAVAILABLE</span><span class="token operator">:</span>
                info <span class="token operator">=</span> <span class="token string">&#39;服务器不可用&#39;</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h5 id="_4-网络错误后客户端重新连接服务器" tabindex="-1"><a class="header-anchor" href="#_4-网络错误后客户端重新连接服务器" aria-hidden="true">#</a> （4）网络错误后客户端重新连接服务器</h5><p>当网络不可用或网络断开导致客户端离线时，开发者可以手动通过 SDK 尝试重连。SDK 提供给开发者重连服务器方法 <code>reconnect</code> ，该功能内部采用定时器递归机制实现。</p><p>重连时提供两种方式，可以自行选择：</p><ul><li>重连单次，调用该方法后 SDK 会尝试重连一次，如果重连成功，会触发 onSuccess 回调，如果重连失败会触发 onError 回调。</li><li>按照给定的重试频率数组进行自动重连，当给定的所有重试时间都用完后而服务器仍未连接上时，会携带 <code>NETWORK_UNAVAILABLE</code> 对应的错误码触发 onError 回调。</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> callback <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">onSuccess</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">userId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Reconnect successfully.&#39;</span> <span class="token operator">+</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">onTokenIncorrect</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;token 无效&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">onError</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">errorCode</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>errorcode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 默认 false, true 启用自动重连，启用则为必选参数</span>
    auto<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// 网络嗅探地址 [http(s)://]cdn.ronghub.com/RongIMLib-2.2.6.min.js 可选</span>
    url<span class="token operator">:</span> <span class="token string">&#39;cdn.ronghub.com/RongIMLib-2.2.6.min.js&#39;</span><span class="token punctuation">,</span>
    <span class="token comment">// 重试频率 [100, 1000, 3000, 6000, 10000, 18000] 单位为毫秒，可选</span>
    rate<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">,</span> <span class="token number">6000</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

RongIMClient<span class="token punctuation">.</span><span class="token function">reconnect</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="➣-前端网关架构" tabindex="-1"><a class="header-anchor" href="#➣-前端网关架构" aria-hidden="true">#</a> ➣ 前端网关架构</h2><h2 id="➣-前端-seo-优化" tabindex="-1"><a class="header-anchor" href="#➣-前端-seo-优化" aria-hidden="true">#</a> ➣ 前端 SEO 优化</h2><h3 id="spa-应用-seo-的优化方式" tabindex="-1"><a class="header-anchor" href="#spa-应用-seo-的优化方式" aria-hidden="true">#</a> SPA 应用 SEO 的优化方式</h3><p>SSG - 服务端是指客户端向服务器发出请求，然后运行时动态生成 html 内容并返回给客户端。 SSR - 静态站点的解析是在构建时执行的，当发出请求时，html 将静态存储，直接发送回客户端。</p><p>下文讲的所有优化方式都建立在网站爬虫能够正确读取到页面结构和网页内容的基础上，单页 SPA 应用因为网页内容使用 Js 脚本生成，爬虫不能正确读取，因此需要 <code>SSR/SSG</code> 等渲染方式进行服务端预处理。</p><h3 id="seo-的目的" tabindex="-1"><a class="header-anchor" href="#seo-的目的" aria-hidden="true">#</a> SEO 的目的</h3><p>让网站更利于各大搜索引擎抓取和收录，增加对搜索引擎的友好度，使得用户在搜索对应关键词时网站时能排在前面，增加产品的曝光率和流量。</p><h3 id="seo-的优化方式" tabindex="-1"><a class="header-anchor" href="#seo-的优化方式" aria-hidden="true">#</a> SEO 的优化方式</h3><h4 id="网页-tdk-标签声明" tabindex="-1"><a class="header-anchor" href="#网页-tdk-标签声明" aria-hidden="true">#</a> 网页 TDK 标签声明</h4><ul><li>title：当前页面的标题（强调重点即可，每个页面的 title 尽量不要相同）</li><li>description：当前页面的描述（列举几个关键词即可，不要过分堆积）</li><li>keywords：当前页面的关键词（高度概括网页内容）</li></ul><h4 id="使用语义化标签" tabindex="-1"><a class="header-anchor" href="#使用语义化标签" aria-hidden="true">#</a> 使用语义化标签</h4><p>根据内容的结构化，选择合适的 HTML5 标签尽量让代码语义化，如使用 header，footer，section，aside，article，nav 等等语义化标签可以让爬虫更好的解析。</p><h4 id="合理使用文本结构标签-h1-h6" tabindex="-1"><a class="header-anchor" href="#合理使用文本结构标签-h1-h6" aria-hidden="true">#</a> 合理使用文本结构标签 <code>h1-h6</code></h4><p>一个页面中只能最多出现一次h1标签，h2标签通常作为二级标题或文章的小标题。其余h3-h6标签如要使用应按顺序层层嵌套下去，不可以断层或反序。比如通常在首页的 logo 上加h1标签。</p><h4 id="图片-alt-标签" tabindex="-1"><a class="header-anchor" href="#图片-alt-标签" aria-hidden="true">#</a> 图片 Alt 标签</h4><p>一般来说，除非是图片仅仅是纯展示类没有任何实际信息的话，alt属性可以为空。否则使用img标签都要添加alt属性，使&quot;蜘蛛&quot;可以抓取到图片的信息。 当网络加载不出来或者图片地址失效时，alt属性的内容才会代替图片呈现出来，</p><h4 id="a-标签-title" tabindex="-1"><a class="header-anchor" href="#a-标签-title" aria-hidden="true">#</a> a 标签 title</h4><p>a 标签的 title 属性其实就是提示文字作用，当鼠标移动到该超链接上时，就会有提示文字的出现。通过添加该属性也有微小的作用利于 SEO。</p><h4 id="_404-页面" tabindex="-1"><a class="header-anchor" href="#_404-页面" aria-hidden="true">#</a> 404 页面</h4><p>404 页面首先是用户体验良好，不会莫名报一些其他提示。其次对蜘蛛也友好，不会因为页面错误而停止抓取，可以返回抓取网站其他页面。</p><h4 id="扁平化目录层次" tabindex="-1"><a class="header-anchor" href="#扁平化目录层次" aria-hidden="true">#</a> 扁平化目录层次</h4><h4 id="优化网站结构布局" tabindex="-1"><a class="header-anchor" href="#优化网站结构布局" aria-hidden="true">#</a> 优化网站结构布局</h4><h4 id="nofollow-忽略跟踪" tabindex="-1"><a class="header-anchor" href="#nofollow-忽略跟踪" aria-hidden="true">#</a> nofollow 忽略跟踪</h4><ul><li>nofollow 有两种用法：</li></ul><ol><li>用于 meta 元标签，告诉爬虫该页面上所有链接都无需追踪。</li></ol><div class="language-abnf ext-abnf line-numbers-mode"><pre class="language-abnf"><code>&lt;meta <span class="token rule">name</span><span class="token operator">=</span><span class="token string">&quot;robots&quot;</span> <span class="token definition keyword">content</span><span class="token operator">=</span><span class="token string">&quot;nofollow&quot;</span> <span class="token operator">/</span>&gt;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ol start="2"><li>用于 a 标签，告诉爬虫该页面无需追踪。</li></ol><div class="language-livecodeserver ext-livecodeserver line-numbers-mode"><pre class="language-livecodeserver"><code>&lt;a href=&quot;https://www.xxxx?login&quot; rel=&quot;nofollow&quot;&gt;登录/注册&lt;/a&gt;
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>通常用在 a 标签比较多，它主要有三个作用：</p><ol><li>&quot;蜘蛛&quot;分配到每个页面的权重是一定的，为了集中网页权重并将权重分给其他必要的链接，就设置<code>rel=&#39;nofollow&#39;</code>告诉&quot;蜘蛛&quot;不要爬，来避免爬虫抓取一些无意义的页面，影响爬虫抓取的效率；而且一旦&quot;蜘蛛&quot;爬了外部链接，就不会再回来了。</li><li>付费链接：为了防止付费链接影响 Google 的搜索结果排名，Google 建议使用 nofollow 属性。</li><li>防止不可信的内容，最常见的是博客上的垃圾留言与评论中为了获取外链的垃圾链接，为了防止页面指向一些拉圾页面和站点。</li></ol><h4 id="建立-robots-txt-文件" tabindex="-1"><a class="header-anchor" href="#建立-robots-txt-文件" aria-hidden="true">#</a> 建立 robots.txt 文件</h4><blockquote><p>robots.txt 文件由一条或多条规则组成。每条规则可禁止（或允许）特定抓取工具抓取相应网站中的指定文件路径。</p></blockquote><div class="language-awk ext-awk line-numbers-mode"><pre class="language-awk"><code>User-agent: *
Disallow:/admin/
SiteMap: http://www.xxxx.com/sitemap.xml
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>关键词：</p><ol><li>User-agent 表示网页抓取工具的名称</li><li>Disallow 表示不应抓取的目录或网页</li><li>Allow 应抓取的目录或网页</li><li>Sitemap 网站的站点地图的位置</li></ol><ul><li><code>User-agent: *</code>表示对所有的搜索引擎有效</li><li><code>User-agent: Baiduspider</code> 表示百度搜索引擎，还有谷歌 Googlebot 等等搜索引擎名称，通过这些可以设置不同搜索引擎访问的内容</li></ul><p>robots 文件是搜索引擎访问网站时第一个访问的，然后根据文件里面设置的规则，进行网站内容的爬取。通过设置<code>Allow</code>和<code>Disallow</code>访问目录和文件，引导爬虫抓取网站的信息。</p><p>它主要用于使你的网站避免收到过多请求，告诉搜索引擎应该与不应抓取哪些页面。如果你不希望网站的某些页面被抓取，这些页面可能对用户无用，就通过<code>Disallow</code>设置。实现定向 SEO 优化，曝光有用的链接给爬虫，将敏感无用的文件保护起来。</p><p>即使网站上面所有内容都希望被搜索引擎抓取到，也要设置一个空的 robot 文件。因为当蜘蛛抓取网站内容时，第一个抓取的文件 robot 文件，如果该文件不存在，那么蜘蛛访问时，服务器上就会有一条 404 的错误日志，多个搜索引擎抓取页面信息时，就会产生多个的 404 错误，故一般都要创建一个 robots.txt 文件到网站根目录下。</p><p>空 robots.txt 文件</p><div class="language-makefile ext-makefile line-numbers-mode"><pre class="language-makefile"><code><span class="token symbol">User-agent</span><span class="token punctuation">:</span> *
<span class="token symbol">Disallow</span><span class="token punctuation">:</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: yangwei13@outlook.com">nojsja</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/frontend-summary/structure/keys.html" class="" aria-label="● 考点梳理"><!--[--><!--]--> ● 考点梳理 <!--[--><!--]--></a></span><!----></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/frontend-summary/assets/app.64694548.js" defer></script>
  </body>
</html>
