<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.32">
    <title>● 基础知识 | NoJsJa Frontend Summary</title><meta name="description" content="React 的描述">
    <link rel="modulepreload" href="/frontend-summary/assets/app.6a7323b4.js"><link rel="modulepreload" href="/frontend-summary/assets/base.html.7f6b2536.js"><link rel="modulepreload" href="/frontend-summary/assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="/frontend-summary/assets/base.html.70ee630b.js">
    <link rel="stylesheet" href="/frontend-summary/assets/style.c7eaaf18.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/frontend-summary/" class=""><img class="logo" src="https://nojsja.gitee.io/blogs/img/avatar/nojsja.jpeg" alt="NoJsJa Frontend Summary"><span class="site-name can-hide">NoJsJa Frontend Summary</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a class="external-link" href="https://nojsja.gitee.io/blogs" rel="noopener noreferrer" target="_blank" aria-label="Blogs"><!--[--><!--]--> Blogs <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/nojsja" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a class="external-link" href="https://nojsja.gitee.io/blogs" rel="noopener noreferrer" target="_blank" aria-label="Blogs"><!--[--><!--]--> Blogs <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/nojsja" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a href="/frontend-summary/" class="sidebar-item sidebar-heading" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/html_css" class="sidebar-item sidebar-heading" aria-label="➣ HTML/CSS 部分"><!--[--><!--]--> ➣ HTML/CSS 部分 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/frontend-summary/html_css/base.html" class="sidebar-item" aria-label="● 基础知识"><!--[--><!--]--> ● 基础知识 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/html_css/keys.html" class="sidebar-item" aria-label="● 考点梳理"><!--[--><!--]--> ● 考点梳理 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/frontend-summary/js" class="sidebar-item sidebar-heading" aria-label="➣ Javascript 部分"><!--[--><!--]--> ➣ Javascript 部分 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/frontend-summary/js/base.html" class="sidebar-item" aria-label="● 基础知识"><!--[--><!--]--> ● 基础知识 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/js/keys.html" class="sidebar-item" aria-label="● 考点梳理"><!--[--><!--]--> ● 考点梳理 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/frontend-summary/react" class="router-link-active sidebar-item sidebar-heading active" aria-label="➣ React 部分"><!--[--><!--]--> ➣ React 部分 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/frontend-summary/react/base.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="● 基础知识"><!--[--><!--]--> ● 基础知识 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/frontend-summary/react/base.html#➣-react-fiber原理" class="router-link-active router-link-exact-active sidebar-item" aria-label="➣ React Fiber原理"><!--[--><!--]--> ➣ React Fiber原理 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/frontend-summary/react/base.html#react架构" class="router-link-active router-link-exact-active sidebar-item" aria-label="React架构"><!--[--><!--]--> React架构 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/frontend-summary/react/base.html#react15遗留问题" class="router-link-active router-link-exact-active sidebar-item" aria-label="React15遗留问题"><!--[--><!--]--> React15遗留问题 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/frontend-summary/react/base.html#react16问题解决" class="router-link-active router-link-exact-active sidebar-item" aria-label="React16问题解决"><!--[--><!--]--> React16问题解决 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/frontend-summary/react/base.html#➣-react新旧生命周期" class="router-link-active router-link-exact-active sidebar-item" aria-label="➣ React新旧生命周期"><!--[--><!--]--> ➣ React新旧生命周期 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/frontend-summary/react/base.html#react16-3之前的生命周期" class="router-link-active router-link-exact-active sidebar-item" aria-label="React16.3之前的生命周期"><!--[--><!--]--> React16.3之前的生命周期 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/frontend-summary/react/base.html#react16-3之后的生命周期" class="router-link-active router-link-exact-active sidebar-item" aria-label="React16.3之后的生命周期"><!--[--><!--]--> React16.3之后的生命周期 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><li><a href="/frontend-summary/react/keys.html" class="sidebar-item" aria-label="● 考点梳理"><!--[--><!--]--> ● 考点梳理 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/frontend-summary/node" class="sidebar-item sidebar-heading" aria-label="➣ Node 部分"><!--[--><!--]--> ➣ Node 部分 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/frontend-summary/node/base.html" class="sidebar-item" aria-label="● 基础知识"><!--[--><!--]--> ● 基础知识 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/node/keys.html" class="sidebar-item" aria-label="● 考点梳理"><!--[--><!--]--> ● 考点梳理 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/frontend-summary/optimization" class="sidebar-item sidebar-heading" aria-label="➣ 前端性能优化"><!--[--><!--]--> ➣ 前端性能优化 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/frontend-summary/optimization/code.html" class="sidebar-item" aria-label="● 编码优化"><!--[--><!--]--> ● 编码优化 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/optimization/http.html" class="sidebar-item" aria-label="● http 优化"><!--[--><!--]--> ● http 优化 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/optimization/build.html" class="sidebar-item" aria-label="● 构建优化"><!--[--><!--]--> ● 构建优化 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/frontend-summary/structure" class="sidebar-item sidebar-heading" aria-label="➣ 前端工程化和架构"><!--[--><!--]--> ➣ 前端工程化和架构 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/frontend-summary/structure/arch.html" class="sidebar-item" aria-label="● 架构"><!--[--><!--]--> ● 架构 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/structure/engineered.html" class="sidebar-item" aria-label="● 工程化"><!--[--><!--]--> ● 工程化 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/structure/project.html" class="sidebar-item" aria-label="● 前项目梳理"><!--[--><!--]--> ● 前项目梳理 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/frontend-summary/network_system" class="sidebar-item sidebar-heading" aria-label="➣ 操作系统和网络"><!--[--><!--]--> ➣ 操作系统和网络 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/frontend-summary/network_system/base.html" class="sidebar-item" aria-label="● 基础知识"><!--[--><!--]--> ● 基础知识 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/network_system/keys.html" class="sidebar-item" aria-label="● 考点梳理"><!--[--><!--]--> ● 考点梳理 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/network_system/http.html" class="sidebar-item" aria-label="● HTTP 协议"><!--[--><!--]--> ● HTTP 协议 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/network_system/https.html" class="sidebar-item" aria-label="● HTTPS 协议"><!--[--><!--]--> ● HTTPS 协议 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/network_system/http2.0.html" class="sidebar-item" aria-label="● HTTP 2.0"><!--[--><!--]--> ● HTTP 2.0 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/frontend-summary/design_pattern" class="sidebar-item sidebar-heading" aria-label="➣ 设计模式"><!--[--><!--]--> ➣ 设计模式 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/frontend-summary/design_pattern/decorator.html" class="sidebar-item" aria-label="● 装饰器模式"><!--[--><!--]--> ● 装饰器模式 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/design_pattern/flyweight.html" class="sidebar-item" aria-label="● 享元模式"><!--[--><!--]--> ● 享元模式 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/design_pattern/observer.html" class="sidebar-item" aria-label="● 观察者模式"><!--[--><!--]--> ● 观察者模式 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/design_pattern/proxy.html" class="sidebar-item" aria-label="● 代理模式"><!--[--><!--]--> ● 代理模式 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/design_pattern/responsibility_chain.html" class="sidebar-item" aria-label="● 责任链模式"><!--[--><!--]--> ● 责任链模式 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/design_pattern/state.html" class="sidebar-item" aria-label="● 状态模式"><!--[--><!--]--> ● 状态模式 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/design_pattern/strategy.html" class="sidebar-item" aria-label="● 策略模式"><!--[--><!--]--> ● 策略模式 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/design_pattern/template.html" class="sidebar-item" aria-label="● 模板方法模式"><!--[--><!--]--> ● 模板方法模式 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/frontend-summary/data" class="sidebar-item sidebar-heading" aria-label="➣ 数据结构"><!--[--><!--]--> ➣ 数据结构 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/frontend-summary/data/keys.html" class="sidebar-item" aria-label="● 考点梳理"><!--[--><!--]--> ● 考点梳理 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/data/base.html" class="sidebar-item" aria-label="● 基础知识"><!--[--><!--]--> ● 基础知识 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/frontend-summary/algorithms" class="sidebar-item sidebar-heading" aria-label="➣ 算法"><!--[--><!--]--> ➣ 算法 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/frontend-summary/algorithms/array.html" class="sidebar-item" aria-label="● 数组"><!--[--><!--]--> ● 数组 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/algorithms/dp.html" class="sidebar-item" aria-label="● 动态规划"><!--[--><!--]--> ● 动态规划 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/algorithms/linked_list.html" class="sidebar-item" aria-label="● 链表"><!--[--><!--]--> ● 链表 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/algorithms/string.html" class="sidebar-item" aria-label="● 字符串处理"><!--[--><!--]--> ● 字符串处理 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/algorithms/sort.html" class="sidebar-item" aria-label="● 排序算法"><!--[--><!--]--> ● 排序算法 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/algorithms/tree.html" class="sidebar-item" aria-label="● 树"><!--[--><!--]--> ● 树 <!--[--><!--]--></a><!----></li><li><a href="/frontend-summary/algorithms/others.html" class="sidebar-item" aria-label="● 其它"><!--[--><!--]--> ● 其它 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h2 id="➣-react-fiber原理" tabindex="-1"><a class="header-anchor" href="#➣-react-fiber原理" aria-hidden="true">#</a> ➣ React Fiber原理</h2><h3 id="react架构" tabindex="-1"><a class="header-anchor" href="#react架构" aria-hidden="true">#</a> React架构</h3><ul><li>1）Virtual DOM 层，描述页面长什么样</li><li>2）Reconciler 层，负责调用组件生命周期方法，进行Diff运算等</li><li>3）Renderer 层，根据不同的平台，渲染出相应的页面，如 ReactDOM 和 ReactNative</li></ul><h3 id="react15遗留问题" tabindex="-1"><a class="header-anchor" href="#react15遗留问题" aria-hidden="true">#</a> React15遗留问题</h3><p><img src="http://nojsja.gitee.io/static-resources/images/react/StackReconciler.jpg" alt="StackReconciler"></p><ul><li>1）浏览器的整体渲染是多线程的，包括GUI渲染线程、JS引擎线程、事件触发线程、定时触发器线程和异步http请求线程。页面绘制和JS运算是互斥的线程，两者不能同时进行。</li><li>2）React15使用JS的函数调用栈(Stack Reconciler)递归渲染界面，因此在处理DOM元素过多的复杂页面的频繁更新时，大量同步进行的任务(树diff和页面render)会导致界面更新阻塞、事件响应延迟、动画卡顿等，因此React团队在16版本重写了React Reconciler架构。</li></ul><h3 id="react16问题解决" tabindex="-1"><a class="header-anchor" href="#react16问题解决" aria-hidden="true">#</a> React16问题解决</h3><p><img src="http://nojsja.gitee.io/static-resources/images/react/FiberReconciler.jpg" alt="FiberReconciler"></p><ul><li>1）<code>Fiber Reconciler</code>架构可以允许同步阻塞的任务拆分成多个小任务，每个任务占用一小段时间片，任务执行完成后判断有无空闲时间，有则继续执行下一个任务，否则将控制权交由浏览器以让浏览器去处理更高优先级的任务，等下次拿到时间片后，其它子任务继续执行。整个流程类似CPU调度逻辑，底层是使用了浏览器API<code>requestIdleCallback</code>。</li><li>2）为了实现整个Diff和Render的流程可中断和恢复，单纯的VirtualDom Tree不再满足需求，React16引入了采用单链表结构的Fiber树，如下图所示。</li><li>3）FiberReconciler架构将更新流程划分成了两个阶段：1.diff(由多个diff任务组成，任务时间片消耗完后被可被中断，中断后由requestIdleCallback再次唤醒) =&gt; 2.commit(diff完毕后拿到fiber tree更新结果触发DOM渲染，不可被中断)。左边灰色部分的树即为一颗fiber树，右边的workInProgress为中间态，它是在diff过程中自顶向下构建的树形结构，可用于断点恢复，所有工作单元都更新完成之后，生成的workInProgress树会成为新的fiber tree。</li><li>4）fiber tree中每个节点即一个工作单元，跟之前的VirtualDom树类似，表示一个虚拟DOM节点。workInProgress tree的每个fiber node都保存着diff过程中产生的effect list，它用来存放diff结果，并且底层的树节点会依次向上层merge effect list，以收集所有diff结果。注意的是如果某些节点并未更新，workInProgress tree会直接复用原fiber tree的节点(链表操作)，而有数据更新的节点会被打上tag标签。</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>FiberNode<span class="token operator">&gt;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    stateNode<span class="token punctuation">,</span>    <span class="token comment">// 节点实例</span>
    child<span class="token punctuation">,</span>        <span class="token comment">// 子节点</span>
    sibling<span class="token punctuation">,</span>      <span class="token comment">// 兄弟节点</span>
    <span class="token keyword">return</span><span class="token punctuation">,</span>       <span class="token comment">// 父节点</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><img src="http://nojsja.gitee.io/static-resources/images/react/FiberTree.png" alt="FiberTree"></p><h2 id="➣-react新旧生命周期" tabindex="-1"><a class="header-anchor" href="#➣-react新旧生命周期" aria-hidden="true">#</a> ➣ React新旧生命周期</h2><h3 id="react16-3之前的生命周期" tabindex="-1"><a class="header-anchor" href="#react16-3之前的生命周期" aria-hidden="true">#</a> React16.3之前的生命周期</h3><p><img src="http://nojsja.gitee.io/static-resources/images/react/react-lifecycle-old.png" alt=""></p><ol><li><p>componentWillMount()<br> 此生命周期函数会在在组件挂载之前被调用，整个生命周期中只被触发一次。开发者通常用来进行一些数据的预请求操作，以减少请求发起时间，建议的替代方案是考虑放入constructor构造函数中，或者componentDidMount后；另一种情况是在在使用了外部状态管理库时，如Mobx，可以用于重置Mobx Store中的的已保存数据，替代方案是使用生命周期componentWilUnmount在组件卸载时自动执行数据清理。</p></li><li><p>componentDidMount()<br> 此生命周期函数在组件被挂载之后被调用，整个生命周期中只触发一次。开发者同样可以用来进行一些数据请求的操作；除此之外也可用于添加事件订阅(需要在componentWillUnmount中取消事件订阅)；因为函数触发时dom元素已经渲染完毕，第三种使用情况是处理一些界面更新的副作用，比如使用默认数据来初始化一个echarts组件，然后在componentDidUpdate后进行echarts组件的数据更新。</p></li><li><p>componentWillReceiveProps(nextProps, nexState)<br> 此生命周期发生在组件挂载之后的组件更新阶段。最常见于在一个依赖于prop属性进行组件内部state更新的非完全受控组件中，非完全受控组件即组件内部维护state更新，同时又在某个特殊条件下会采用外部传入的props来更新内部state，注意不要直接将props完全复制到state，否则应该使用完全受控组件<code>Function Component</code>，一个例子如下：</p></li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">EmailInput</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span> email<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>email <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>input onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">}</span> value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>email<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function-variable function">handleChange</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> his<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> email<span class="token operator">:</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span><span class="token parameter">nextProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextProps<span class="token punctuation">.</span>userID <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>userID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> email<span class="token operator">:</span> nextProps<span class="token punctuation">.</span>email <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><ol start="4"><li>shouldComponentUpdate(nextProps)<br> 此生命周期发生在组件挂载之后的组件更新阶段。<br> 值得注意的是子组件更新不一定是由于props或state改变引起的，也可能是父组件的其它部分更改导致父组件重渲染而使得当前子组件在props/state未改变的情况下重新渲染一次。<br> 函数被调用时会被传入即将更新的<code>nextProps</code>和<code>nextState</code>对象，开发者可以通过对比前后两个props对象上与界面渲染相关的属性是否改变，再决定是否允许这次更新(return <code>true</code>表示允许执行更新，否则忽略更新，默认为<code>true</code>)。常搭配对象深比较函数用于减少界面无用渲染次数，优化性能。在一些只需要简单浅比较props变化的场景下，并且相同的state和props会渲染出相同的内容时，建议使用<code>React.PureComponnet</code>替代，在props更新时React会自动帮你进行一次浅比较，以减少不必要渲染。</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">EmailInput</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span> email<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>email <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>input onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">}</span> value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>email<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function-variable function">handleChange</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> his<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> email<span class="token operator">:</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      nextProps<span class="token punctuation">.</span>userID <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>userID <span class="token operator">&amp;&amp;</span>
      nextState<span class="token punctuation">.</span>email <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>email
    <span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ol start="5"><li>componenetWillUpdate(newProps, newState)<br> 此生命周期发生在组件挂载之后的更新阶段。当组件收到新的props或state，并且<code>shouldComponentUpdate</code>返回允许更新时，会在渲染之前调此方法，不可以在此生命周期执行<code>setState</code>。在此生命周期中开发者可以在界面实际渲染更新之前拿到最新的<code>nextProps</code>和<code>nextState</code>，从而执行一些副作用：比如触发一个事件、根据最新的props缓存一些计算数据到组件内、平滑界面元素动画等：</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code> <span class="token comment">// 需要搭配css属性transition使用</span>
 <span class="token function-variable function">componentWillUpdate</span> <span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">newProps<span class="token punctuation">,</span>newState</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>newState<span class="token punctuation">.</span>show<span class="token punctuation">)</span>
      <span class="token function">$</span><span class="token punctuation">(</span>ReactDOM<span class="token punctuation">.</span><span class="token function">findDOMNode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>refs<span class="token punctuation">.</span>elem<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;opacity&#39;</span><span class="token operator">:</span><span class="token string">&#39;1&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
      <span class="token function">$</span><span class="token punctuation">(</span>ReactDOM<span class="token punctuation">.</span><span class="token function">findDOMNode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>refs<span class="token punctuation">.</span>elem<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;opacity&#39;</span><span class="token operator">:</span><span class="token string">&#39;0&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">componentDidUpdate</span> <span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">oldProps<span class="token punctuation">,</span>oldState</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>show<span class="token punctuation">)</span>
      <span class="token function">$</span><span class="token punctuation">(</span>ReactDOM<span class="token punctuation">.</span><span class="token function">findDOMNode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>refs<span class="token punctuation">.</span>elem<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;opacity&#39;</span><span class="token operator">:</span><span class="token string">&#39;1&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
      <span class="token function">$</span><span class="token punctuation">(</span>ReactDOM<span class="token punctuation">.</span><span class="token function">findDOMNode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>refs<span class="token punctuation">.</span>elem<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;opacity&#39;</span><span class="token operator">:</span><span class="token string">&#39;0&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ol start="6"><li>componenetDidUpdate(prevProps, prevState)<br> 此生命周期发生在组件挂载之后的更新阶段，组件初次挂载不会触发。当组件的props和state改变引起界面渲染更新后，此函数会被调用，不可以在此生命周期执行<code>setState</code>。我们使用它用来执行一些副作用：比如条件式触发必要的网络请求来更新本地数据、使用render后的最新数据来调用一些外部库的执行(例子：定时器请求接口数据动态绘制echarts折线图)：</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>  <span class="token operator">...</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>echartsElement <span class="token operator">=</span> echarts<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>refs<span class="token punctuation">.</span>echart<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>echartsElement<span class="token punctuation">.</span><span class="token function">setOption</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>defaultData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> treeData <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    <span class="token keyword">const</span> optionData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>echartsElement<span class="token punctuation">.</span><span class="token function">getOption</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    optionData<span class="token punctuation">.</span>series<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">[</span>treeData<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>echartsElement<span class="token punctuation">.</span><span class="token function">setOption</span><span class="token punctuation">(</span>optionData<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ol start="7"><li>componentWillUnmount()<br> 此生命周期发生在组件卸载之前，组件生命周期中只会触发一次。开发者可以在此函数中执行一些数据清理重置、取消页面组件的事件订阅等。</li></ol><h3 id="react16-3之后的生命周期" tabindex="-1"><a class="header-anchor" href="#react16-3之后的生命周期" aria-hidden="true">#</a> React16.3之后的生命周期</h3><p><img src="http://nojsja.gitee.io/static-resources/images/react/react-lifecycle.png" alt=""></p><p>React16.3之后React的<code>Reconciler</code>架构被重写(Reconciler用于处理生命周期钩子函数和DOM DIFF)，之前版本采用函数调用栈递归同步渲染机制即Stack Reconciler，dom的diff阶段不能被打断，所以不利于动画执行和事件响应。React团队使用Fiber Reconciler架构之后，diff阶段根据虚拟DOM节点拆分成包含多个工作任务单元(FiberNode)的Fiber树(以链表实现)，实现了Fiber任务单元之间的任意切换和任务之间的打断及恢复等等。Fiber架构下的异步渲染导致了<code>componentWillMount</code>、<code>componentWillReceiveProps</code>、<code>componentWillUpdate</code>三个生命周期在实际渲染之前可能会被调用多次，产生不可预料的调用结果，因此这三个不安全生命周期函数不建议被使用。取而代之的是使用全新的两个生命周期函数：<code>getDerivedStateFromProps</code>和<code>getSnapshotBeforeUpdate</code>。</p><ol><li><strong>getDerivedStateFromProps(nextProps, currentState)</strong></li></ol><ul><li>1）定义<br> 此生命周期发生在组件初始化挂载和组件更新阶段，开发者可以用它来替代之前的<code>componentWillReceiveProps</code>生命周期，可用于根据props变化来动态设置组件内部state。<br> 函数为static静态函数，因此我们无法使用<code>this</code>直接访问组件实例，也无法使用<code>this.setState</code>直接对state进行更改，以此可以看出React团队想通过React框架的API式约束来尽量减少开发者的API滥用。函数调用时会被传入即将更新的props和当前组件的state数据作为参数，我们可以通过对比处理props然后返回一个对象来触发的组件state更新，如果返回null则不更新任何内容。</li><li>2）滥用场景一：直接复制props到state上面<br> 这会导致父层级重新渲染时，SimpleInput组件的state都会被重置为父组件重新传入的props，不管props是否发生了改变。如果你说使用<code>shouldComponentUpdate</code>搭配着避免这种情况可以吗？代码层面上可以，不过可能导致后期<code>shouldComponentUpdate</code>函数的数据来源混乱，任何一个prop的改变都会导致重新渲染和不正确的状态重置，维护一个可靠的<code>shouldComponentUpdate</code>会更难。</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">SimpleInput</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span> attr<span class="token operator">:</span> <span class="token string">&#39;&#39;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>input onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> attr<span class="token operator">:</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span> value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>attr<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> currentState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这会覆盖所有组件内的state更新！</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> attr<span class="token operator">:</span> nextProps<span class="token punctuation">.</span>attr <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li>3）使用场景： 在props变化后选择性修改state</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">SimpleInput</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span> attr<span class="token operator">:</span> <span class="token string">&#39;&#39;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>input onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> attr<span class="token operator">:</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span> value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>attr<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> currentState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextProps<span class="token punctuation">.</span>attr <span class="token operator">!==</span> currentState<span class="token punctuation">.</span>attr<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">{</span> attr<span class="token operator">:</span> nextProps<span class="token punctuation">.</span>attr <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>可能导致的bug：在需要重置SimpleInput组件的情况下，由于<code>props.attr</code>未改变，导致组件无法正确重置状态，表现就是input输入框组件的值还是上次遗留的输入。</p><ul><li>4）优化的使用场景一：使用完全可控的组件<br> 完全可控的组件即没有内部状态的功能组件，其状态的改变完全受父级props控制，这种方式需要将原本位于组件内的state和改变state的逻辑方法抽离到父级。适用于一些简单的场景，不过如果父级存在太多的子级状态管理逻辑也会使逻辑冗余复杂化。</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">SimpleInput</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>input onChange<span class="token operator">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>onChange<span class="token punctuation">}</span> value<span class="token operator">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>attr<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>5）优化的使用场景二：使用有key值的非可控的组件<br> 如果我们想让组件拥有自己的状态管理逻辑，但是在适当的条件下我们又可以控制组件以新的默认值重新初始化，这里有几种方法参考：</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* 
  1. 设置一个唯一值传入作为组件重新初始化的标志
     通过对比属性手动让组件重新初始化
*/</span>
<span class="token keyword">class</span> <span class="token class-name">SimpleInput</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span> attr<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>attr<span class="token punctuation">,</span> id<span class="token operator">=</span><span class="token string">&quot;&quot;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 初始化默认值</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>input onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> attr<span class="token operator">:</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span> value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>attr<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> currentState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextProps<span class="token punctuation">.</span>id <span class="token operator">!==</span> currentState<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> attr<span class="token operator">:</span> nextProps<span class="token punctuation">.</span>attr<span class="token punctuation">,</span> id<span class="token operator">:</span> nextProps<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
  2. 设置一个唯一值作为组件的key值
     key值改变后组件会以默认值重新初始化
  */</span>
<span class="token keyword">class</span> <span class="token class-name">SimpleInput</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span> attr<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>attr  <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 初始化默认值</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>input onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> attr<span class="token operator">:</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span> value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>attr<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token operator">&lt;</span>SimpleInput
  attr<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>attr<span class="token punctuation">}</span>
  key<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>id<span class="token punctuation">}</span>
<span class="token operator">/</span><span class="token operator">&gt;</span>

<span class="token comment">/*
  3. 提供一个外部调用函数以供父级直接调用以重置组件状态
     父级通过refs来访问组件实例，拿到组件的内部方法进行调用
  */</span>
<span class="token keyword">class</span> <span class="token class-name">SimpleInput</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span> attr<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>attr  <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 初始化默认值</span>

  <span class="token function-variable function">resetState</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> attr<span class="token operator">:</span> value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>input onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> attr<span class="token operator">:</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span> value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>attr<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token operator">&lt;</span>SimpleInput
  attr<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>attr<span class="token punctuation">}</span>
  ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>simpleInput<span class="token punctuation">}</span>
<span class="token operator">/</span><span class="token operator">&gt;</span>


</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><ol start="2"><li><p>componentDidMount()<br> ...</p></li><li><p>shouldComponentUpdate(nextProps, nexState)<br> ...</p></li><li><p><strong>getSnapshotBeforeUpdate(prevProps, prevState)</strong><br> 此生命周期发生在组件初始化挂载和组件更新阶段，界面实际render之前。开发者可以拿到组件更新前的<code>prevProps</code>和<code>prevState</code>，同时也能获取到dom渲染之前的状态(比如元素宽高、滚动条长度和位置等等)。此函数的返回值会被作为<code>componentWillUpdate</code>周期函数的第三个参数传入，通过搭配<code>componentDidUpdate</code>可以完全替代之前<code>componentWillUpdate</code>部分的逻辑，见以下示例。</p></li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">ScrollingList</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>listRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">getSnapshotBeforeUpdate</span><span class="token punctuation">(</span><span class="token parameter">prevProps<span class="token punctuation">,</span> prevState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 判断是否在list中添加新的items </span>
    <span class="token comment">// 捕获滚动​​位置以便我们稍后调整滚动位置。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>prevProps<span class="token punctuation">.</span>list<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>list<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>listRef<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
      <span class="token keyword">return</span> list<span class="token punctuation">.</span>scrollHeight <span class="token operator">-</span> list<span class="token punctuation">.</span>scrollTop<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token parameter">prevProps<span class="token punctuation">,</span> prevState<span class="token punctuation">,</span> snapshot</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调整滚动位置使得这些新items不会将旧的items推出视图</span>
    <span class="token comment">// snapshot是getSnapshotBeforeUpdate的返回值）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>snapshot <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>listRef<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
      list<span class="token punctuation">.</span>scrollTop <span class="token operator">=</span> list<span class="token punctuation">.</span>scrollHeight <span class="token operator">-</span> snapshot<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>listRef<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token comment">/* ...list items... */</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><ol start="5"><li><p><strong>componenetDidUpdate(prevProps, prevState, shot)</strong><br> 此生命周期新增特性：<code>getSnapshotBeforeUpdate</code>的返回值作为此函数执行时传入的第三个参数。</p></li><li><p>componenetWillUnmount<br> ...</p></li></ol><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><!----></footer><nav class="page-nav"><p class="inner"><!----><span class="next"><a href="/frontend-summary/react/keys.html" class="" aria-label="● 考点梳理"><!--[--><!--]--> ● 考点梳理 <!--[--><!--]--></a></span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/frontend-summary/assets/app.6a7323b4.js" defer></script>
  </body>
</html>
